##### 百度搜索同步系统

---
系统组成：

---

- 账户结构生产任务派发器
- 账户结构消费任务派发器
- 报告数据生产任务派发器
- 报告数据消费任务派发器
- 账户结构生产服务
- 账户结构消费服务
- 报告数据生产服务
- 报告数据消费服务


---
业务解析：

---

> 账户结构生产任务派发逻辑

- 流程图
```
graph TD
A[获取有效的百度搜索账户列表A1]-->|C01. 检查账户列表是否为空|C1{列表检查}
C1{列表检查}-->|C02. 列表空|B[结束]
C1{列表检查}-->|C03. 列表不为空|C[获取账户结构同步时限]
C[获取账户结构同步时限]-->|C04. 检查当前时间是否小于同步时限|C2{时限检查}
C2{时限检查}-->|C05. 小于|B[结束]
C2{时限检查}-->|C05. 大于等于|D[获取同步统计信息S1]
D[获取同步统计信息S1]-->E[获取同步统计信息S2]
E[获取同步统计信息S2]-->F[扫描账户列表A1]
F[扫描账户列表A1]-->G[获取账户InputId]
G[获取账户InputId]-->|C06. 检查当前任务是否在统计列表S1中|C3{运行检查}
C3{运行检查}-->|C07. 在统计列表中|C4{状态检查}
C4{状态检查}-->|C08. 被杀死或失败状态|H[重新运行该任务]
H[重新运行该任务]-->J[放入待提交任务列表]
J[放入待提交任务列表]-->|C09. 结束本次循环|F[扫描账户列表A1]
C4{状态检查}-->|C10. 已完成|C5{账户同步检查}
C5{账户同步检查}-->|C11. 当日账户结构未同步|I[创建同步任务]
I[创建同步任务]-->J[放入待提交任务列表]
J[放入待提交任务列表]-->|C12. 结束本次循环|F[扫描账户列表A1]
C5{账户同步检查}-->|C13. 当日账户结构已同步|C6{回溯任务检查}
C6{回溯任务检查}-->|C14. 有回溯任务|K[创建同步任务]
K[创建同步任务]-->J[放入待提交任务列表]
J[放入待提交任务列表]-->|C15. 结束本次循环|F[扫描账户列表A1]
C3{运行检查}-->|C07. 不在统计列表中|L[创建同步任务]
L[创建同步任务]-->J[放入待提交任务列表]
J[放入待提交任务列表]-->|C16. 结束本次循环|F[扫描账户列表A1]

```
- 算法步骤
```
1) 获取有效的百度搜索账户列表A1，如果A1为空，则直接退出
2) 获取结构数据同步时限（每日同步最早同步时间），如果当前时间小于同步时限，则直接退出
3) 获取最新的账户结构生产同步统计信息（来自JobManager）S1
4) 获取最新的可区分回溯任务的账户结构生产同步统计信息S2
5) 扫描账户列表A1
   5.1) 获取账户的InputId(InputId={ProfileKey_CampaignKey_AccountId})
   5.2) 通过5.1中InputId，检查当前账户是否在统计列表S1中，如果在统计列表中
        5.2.1) 检查状态，如果任务状态处于Killed或失败状态，则重新提交该任务，退出，重新执行步骤5（该过程重试次数超出配置指定次数，则延迟重试，延迟间隔10分钟）
        5.2.2) 检查状态，如果任务状态处于已完成状态，首先检查今天该账户是否已同步数据结构，如果未同步，则创建一个同步任务，放入提交列表C1中，退出，重新执行步骤5
               如果今天账户已同步，则检查是否有回溯任务，如果有，优先处理系统回溯任务，最后处理用户回溯任务，创建一个同步任务，放入提交列表C1中，退出，重新执行步骤5
   5.3) 如果不在统计列表中，则创建一个新的同步任务放入同步列表C1中，退出，重新执行步骤5
6) 扫描结束，如果任务提交列表不为空，则向JobManager批量提交任务。

```



> 账户结构消费任务派发逻辑

```
1) 获取有效的百度搜索账户列表A1，如果A1为空，则直接退出
2) 获取最新的账户结构消费同步统计信息（来自JobManager）S1
3) 获取最新的账户结构未消费的生产同步统计信息（来自JobManager）S2
5) 扫描账户列表A1
   5.1) 获取账户的InputId(InputId={ProfileKey_CampaignKey_AccountId})
   5.2) 通过5.1中InputId，检查当前账户是否在统计列表S1中，如果在统计列表中, 检查状态，如果任务状态处于Killed或失败状态，则重新提交该任务，退出，重新执行步骤5
   5.3) 通过5.1中InputId，检查当前账户是否在为消费统计列表S2中，生成新的任务放入提交队列C1，退出，重新执行步骤5
6) 扫描结束，如果任务提交列表不为空，则向JobManager批量提交任务。

```

> 报告生产任务派发逻辑

```
1) 获取有效的百度搜索账户列表A1，如果A1为空，则直接退出
2) 获取报告同步时限（昨日报告同步最早同步时间）
3) 获取最新的报告生产同步统计信息（来自JobManager）S1
4) 获取最新的可区分回溯任务的报告生产同步统计信息（来自JobManager）S2
5) 扫描账户列表A1
   5.1) 获取账户的InputId(InputId={ProfileKey_CampaignKey_AccountId})
   5.2) 通过5.1中InputId，检查当前账户是否在统计列表S1中，如果在统计列表中
        5.2.1) 检查状态，如果任务状态处于Killed或失败状态，则重新提交该任务，退出，重新执行步骤5（该过程重试次数超出配置指定次数，则延迟重试，延迟间隔10分钟）
        5.2.2) 检查状态，如果任务状态处于已完成状态，首先检查该账户昨天报告是否已同步，如果未同步，则判断是否符合报告同步时限，如果符合，则创建一个同步任务，放入提交列表C1中，退出，重新执行步骤5
               如果昨天报告已同步，则检查是否有回溯任务，如果有，则判断是否符合报告同步时限，如果符合，则优先处理系统回溯任务，最后处理用户回溯任务，创建一个同步任务，放入提交列表C1中，退出，重新执行步骤5
   5.3) 如果不在统计列表中，则判断是否符合报告同步时限，如果符合，则创建一个新的同步任务放入同步列表C1中，退出，重新执行步骤5
6) 扫描结束，如果任务提交列表不为空，则向JobManager批量提交任务。

```

> 报告消费任务派发逻辑

```
1) 获取有效的百度搜索账户列表A1，如果A1为空，则直接退出
2) 获取最新的报告消费同步统计信息（来自JobManager）S1
3) 获取最新的报告未消费的生产同步统计信息（来自JobManager）S2
5) 扫描账户列表A1
   5.1) 获取账户的InputId(InputId={ProfileKey_CampaignKey_AccountId})
   5.2) 通过5.1中InputId，检查当前账户是否在统计列表S1中，如果在统计列表中, 检查状态，如果任务状态处于Killed或失败状态，则重新提交该任务，退出，重新执行步骤5
   5.3) 通过5.1中InputId，检查当前账户是否在为消费统计列表S2中，生成新的任务放入提交队列C1，退出，重新执行步骤5
6) 扫描结束，如果任务提交列表不为空，则向JobManager批量提交任务。

```

